# Setup macOS (works on macOS 10.12.2b2) render with Halide

####
# Updated: 2017-01-02 by Holger Eilhard <holger@eilhard.net>
# Used with upstream commit: 8d323f09e77b010a4cfa5e9045c89dea107b0e34 (Date: Fri Dec 30 17:24:45 2016 -0800)
####

###
# Install Xcode from Mac App Store
###

###
# Install Homebrew
###
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"


###
# Install git
###
brew install git python gflags glog wget curl wxpython wxmac
brew link wxmac


###
# Install ffmpeg (from source!)
###
brew install ffmpeg --with-fdk-aac --with-ffplay --with-freetype --with-libass --with-libquvi --with-libvorbis --with-libvpx --with-opus --with-x265


###
# Install Gooey
###
pip install --upgrade pip
sudo pip install Gooey


###
# Install opencv
###
brew install opencv3 --HEAD
brew link --force opencv3 --HEAD


###
# Install folly
###
brew install folly


###
# Install ceres-solver (from source to work around possible versioning issues with Eigen!)
###
brew install -s ceres-solver


###
# Install llvm
###
cd ~/src
svn co https://llvm.org/svn/llvm-project/llvm/branches/release_37 llvm3.7
svn co https://llvm.org/svn/llvm-project/cfe/branches/release_37 llvm3.7/tools/clang
cd llvm3.7
mkdir build && cd build
cmake -DLLVM_ENABLE_TERMINFO=OFF -DLLVM_TARGETS_TO_BUILD="X86;ARM;NVPTX;AArch64;Mips;PowerPC" -DLLVM_ENABLE_ASSERTIONS=ON -DCMAKE_BUILD_TYPE=Release ..
make -j8
export LLVM_CONFIG=$HOME/src/llvm3.7/build/bin/llvm-config
export LLVM_ROOT=$HOME/src/llvm3.7/build
export CLANG=$HOME/src/llvm3.7/build/bin/clang


###
# Install Halide
###
cd ~/src
git clone https://github.com/halide/Halide.git
cd Halide
mkdir cmake_build && cd cmake_build
cmake -DLLVM_BIN=${LLVM_ROOT}/bin -DLLVM_INCLUDE="${LLVM_ROOT}/../include;${LLVM_ROOT}/include" -DLLVM_LIB=${LLVM_ROOT}/lib -DLLVM_VERSION=37 ..
make -j8


###
# Build surround360_render (with Halide)
###
cd ~/src/Surround360/surround360_render
cmake -DCMAKE_BUILD_TYPE=Release -DHALIDE_DIR=$HOME/src/Halide/cmake_build
make -j8

echo "Now start the GUI:"
echo "python scripts/run_all.py"
